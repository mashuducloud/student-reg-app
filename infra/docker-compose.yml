---
services:
  app:
    image: student-app
    build:
      context: ..
      dockerfile: infra/Dockerfile.backend
      args:
        INSTALL_DEV: "false"   # prod image: no pytest etc.
    container_name: student-app
    depends_on:
      mysql-db:
        condition: service_healthy
      otel-collector:
        condition: service_started
    ports:
      - "5000:5000"     # Flask API
      - "9100:9100"     # Prometheus metrics (app)
    env_file:
      - ./.env
    networks:
      - ${DOCKER_NETWORK}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:5000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 60s

  mysql-db:
    image: mysql-db
    build:
      context: ..
      dockerfile: infra/Dockerfile.db
    container_name: mysql-db
    restart: always
    env_file:
      - ./.env
    ports:
      - "3307:3306"
    networks:
      - ${DOCKER_NETWORK}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: |
        mysqladmin ping -h 127.0.0.1 -uroot -p$$MYSQL_ROOT_PASSWORD || exit 1
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 40s

  flyway:
    build:
      context: ..
      dockerfile: infra/Dockerfile.flyway
    image: my-flyway-migrations
    container_name: flyway-migrations
    depends_on:
      mysql-db:
        condition: service_healthy

    env_file:
      - ./.env

    environment:
      FLYWAY_URL: jdbc:mysql://${DB_HOST:-mysql-db}:${DB_PORT:-3306}/${DB_NAME:-student_registration_db}?allowPublicKeyRetrieval=true&useSSL=false
      FLYWAY_USER: ${DB_USER}
      FLYWAY_PASSWORD: ${DB_PASSWORD}
      FLYWAY_CONNECT_RETRIES: 60
      FLYWAY_LOCATIONS: filesystem:/flyway/sql

    # âœ… Healthcheck: becomes healthy once migrations have run
    healthcheck:
      test: ["CMD-SHELL", "[ -f /flyway/.migrated ]"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s

    networks:
      - ${DOCKER_NETWORK}

  frontend:
    image: student-frontend
    build:
      context: ..
      dockerfile: infra/Dockerfile.frontend
    container_name: student-frontend
    ports:
      - "8080:80"
    networks:
      - ${DOCKER_NETWORK}
    depends_on:
      app:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:80/index.html || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 6
      start_period: 20s

  otel-collector:
    build:
      context: ..
      dockerfile: infra/Dockerfile.otelcol
    image: infra-otel-collector
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "43171:4317"
      - "43181:4318"
    restart: always
    networks:
      - ${DOCKER_NETWORK}
    healthcheck:
      # 13133 is the default health port for the collector
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:13133/ || (ps aux | grep -q otelcol && exit 0) || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 12
      start_period: 90s

  tempo:
    build:
      context: ..
      dockerfile: infra/Dockerfile.tempo
    image: infra-tempo
    container_name: infra-tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./tempo.yaml:/etc/tempo.yaml:ro
    ports:
      - "3201:3200"
    restart: always
    networks:
      - ${DOCKER_NETWORK}
      # No healthcheck here: base image has no curl/wget,
      # and you already confirmed /metrics works from the host.

  prometheus:
    image: infra-prometheus
    build:
      context: ..
      dockerfile: infra/Dockerfile.prometheus
    container_name: infra-prometheus
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    restart: always
    networks:
      - ${DOCKER_NETWORK}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:9090/-/ready || curl -fsS http://127.0.0.1:9090/metrics || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 40s

  grafana:
    build:
      context: ..
      dockerfile: infra/Dockerfile.grafana
    image: infra-grafana
    container_name: infra-grafana
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:3300/
      - GF_SERVER_DOMAIN=localhost
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_PATHS_PROVISIONED_DASHBOARDS=/var/lib/grafana/dashboards

      # --- Entra ID OAuth2 / OIDC ---
      - GF_AUTH_GENERIC_OAUTH_ENABLED=true
      - GF_AUTH_GENERIC_OAUTH_NAME=Microsoft Entra ID
      - GF_AUTH_GENERIC_OAUTH_ALLOW_SIGN_UP=true

      - GF_AUTH_GENERIC_OAUTH_CLIENT_ID=${GRAFANA_OAUTH_CLIENT_ID}
      - GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET=${GRAFANA_OAUTH_CLIENT_SECRET}

      - GF_AUTH_GENERIC_OAUTH_AUTH_URL=https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/authorize
      - GF_AUTH_GENERIC_OAUTH_TOKEN_URL=https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/token
      - GF_AUTH_GENERIC_OAUTH_API_URL=https://graph.microsoft.com/oidc/userinfo

      - GF_AUTH_GENERIC_OAUTH_SCOPES=openid profile email offline_access

      # Optional: auto-login & disable local login form
      - GF_AUTH_OAUTH_AUTO_LOGIN=true
      - GF_AUTH_DISABLE_LOGIN_FORM=true

      # Role mapping from .env
      - GF_AUTH_GENERIC_OAUTH_ROLE_ATTRIBUTE_PATH=${GRAFANA_ROLE_ATTRIBUTE_PATH}

      # Debug OAuth if needed
      - GF_LOG_FILTERS=auth.generic_oauth:debug
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3300:3000"
    restart: always
    networks:
      - ${DOCKER_NETWORK}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3000/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 8
      start_period: 40s

  tests:
    profiles: ["test"]        # ðŸ‘ˆ only run with `--profile test`
    build:
      context: ..
      dockerfile: infra/Dockerfile.backend
      args:
        INSTALL_DEV: "true"   # ðŸ‘ˆ see next section
    container_name: student-api-tests
    working_dir: /app
    command: pytest test_app.py --cov=. --cov-report=term-missing -v
    depends_on:
      mysql-db:
        condition: service_healthy
    env_file:
      - ./.env
    environment:
      DB_HOST: mysql-db
      DB_PORT: 3306
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      PYTHONPATH: /app
    networks:
      - ${DOCKER_NETWORK}
    restart: "no"

  # --- Loki (logs store) ---
  loki:
    build:
      context: ..
      dockerfile: infra/Dockerfile.loki
    image: infra-loki
    container_name: infra-loki
    command: ["-config.file=/etc/loki/config.yaml"]
    volumes:
      - ./loki-config.yaml:/etc/loki/config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    networks:
      - ${DOCKER_NETWORK}
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:3100/ready || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- Promtail (log shipper) ---
  promtail:
    build:
      context: ..
      dockerfile: infra/Dockerfile.promtail
    image: infra-promtail
    container_name: infra-promtail
    command: ["-config.file=/etc/promtail/config.yaml"]
    ports:
      - "9080:9080"
    volumes:
      - ./promtail-config.yaml:/etc/promtail/config.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - promtail-positions:/run/promtail
    networks:
      - ${DOCKER_NETWORK}
    restart: always
    depends_on:
      loki:
        condition: service_started
    # (optional) remove this if you want to avoid flapping on slow boots
    healthcheck:
      test: ["CMD", "/usr/bin/promtail", "-config.file=/etc/promtail/config.yaml", "-server.http-listen-port=9080"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s

networks:
  observability-network:
    driver: bridge

volumes:
  grafana-data:
    driver: local
  loki-data:
    driver: local
  promtail-positions:
    driver: local
  mysql-data:
    driver: local
